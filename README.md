# ğŸ§© Database Utility Library --- æœ€æ–°ç‰ˆ

ã“ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¯ **PDO** ã¾ãŸã¯ **MySQLi** ã‚’ç”¨ã„ã¦ã€\
å®‰å…¨ã‹ã¤ã‚·ãƒ³ãƒ—ãƒ«ã« SQL ã‚’å®Ÿè¡Œã§ãã‚‹è»½é‡ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ã§ã™ã€‚

æš—å·åŒ–ã‚«ãƒ©ãƒ ã®è‡ªå‹•å‡¦ç†ã€JOINã‚’å«ã‚€SELECTã®è‡ªå‹•å¾©å·ã€\
ã•ã‚‰ã« `INSERT ... SELECT`
æ§‹æ–‡ã‚’ã‚¢ãƒ—ãƒªå´ã§å†ç¾ï¼ˆå¾©å·â†’å†æš—å·åŒ–ï¼‰ã§ãã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚

------------------------------------------------------------------------

## ğŸš€ ä¸»ãªç‰¹å¾´

-   âœ… **PDO / MySQLi** ä¸¡å¯¾å¿œ\
-   ğŸ” æš—å·åŒ–ã‚­ãƒ¼ã‚’æŒ‡å®šã™ã‚‹ã¨è‡ªå‹•ã§ **æš—å·åŒ–ï¼å¾©å·**\
-   ğŸ”„
    **JOINã‚’å«ã‚€SELECTã§ã‚‚è‡ªå‹•å¾©å·å¯¾å¿œ**ï¼ˆåˆ—ãƒ¡ã‚¿æƒ…å ±ï¼‹ASã‚¨ã‚¤ãƒªã‚¢ã‚¹è¦ç´„ï¼‰\
-   ğŸ“¦ **INSERT ... SELECT** ã‚‚å¾©å·ä»˜ãã§è‡ªå‹•å‡¦ç†ï¼ˆæ“¬ä¼¼å®Ÿè¡Œï¼‰\
-   ğŸ§± ãƒã‚¤ãƒ³ãƒ‰ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿æ–¹å¼ã«ã‚ˆã‚‹å®‰å…¨ãªSQLå®Ÿè¡Œ\
-   ğŸ” ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³åˆ¶å¾¡å¯¾å¿œ\
-   ğŸ§© çµ±ä¸€ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã§ã®çµæœè¿”å´

------------------------------------------------------------------------

## âš™ï¸ è¨­å®šæ–¹æ³•ï¼ˆconfig.phpï¼‰

``` php
return [
    'type' => 'pdo',        // "pdo" ã¾ãŸã¯ "mysqli"
    'host' => 'localhost',  // ãƒ›ã‚¹ãƒˆå
    'dbname' => 'mydb',     // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å
    'user' => 'root',       // DBãƒ¦ãƒ¼ã‚¶ãƒ¼å
    'pass' => '',           // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰
    'charset' => 'utf8mb4', // æ¨å¥¨

    // ğŸ” æš—å·åŒ–è¨­å®š
    'encryption_key' => 'your-secret-key',

    // è‡ªå‹•æš—å·åŒ–è¨­å®šï¼ˆãƒ†ãƒ¼ãƒ–ãƒ« => ã‚«ãƒ©ãƒ é…åˆ—ï¼‰
    'encrypt_columns' => [
        'users' => ['user_id', 'email', 'password'],
        'orders' => ['name', 'address', 'tel']
    ],
];
```

> ğŸ’¡ `encryption_key` ã‚’è¨­å®šã™ã‚‹ã¨ã€\
> `encrypt_columns` ã«ç™»éŒ²ã•ã‚ŒãŸã‚«ãƒ©ãƒ ã¯è‡ªå‹•ã§æš—å·åŒ–ï¼å¾©å·ã•ã‚Œã¾ã™ã€‚

------------------------------------------------------------------------

## ğŸ“˜ ä½¿ç”¨æ–¹æ³•

### 1ï¸âƒ£ ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿

``` php
require_once 'config.php';
require_once 'database.php';

$db = new Database($config['db']);
```

------------------------------------------------------------------------

### 2ï¸âƒ£ ã‚¯ã‚¨ãƒªã®å®Ÿè¡Œ

``` php
$result = $db->query($sql, $params);
```

#### æˆ»ã‚Šå€¤

``` php
[
  "success" => true,        // æˆåŠŸæ™‚ã¯ true
  "error"   => "",          // ã‚¨ãƒ©ãƒ¼å†…å®¹ï¼ˆå¤±æ•—æ™‚ï¼‰
  "data"    => [...],       // SELECTæ™‚ã®çµæœé…åˆ—
  "last_insert_id" => 123   // INSERTæ™‚ã®ã¿ï¼ˆPDO/MySQLiå…±é€šï¼‰
]
```

------------------------------------------------------------------------

### 3ï¸âƒ£ SELECTï¼ˆJOINå«ã‚€ï¼‰ä¾‹

JOINã‚’å«ã‚€ã‚¯ã‚¨ãƒªã§ã‚‚ã€è‡ªå‹•çš„ã«æš—å·ã‚«ãƒ©ãƒ ã‚’å¾©å·ã—ã¾ã™ã€‚\
PDOç’°å¢ƒã§ã‚‚å®‰å…¨ã«æ‰±ã†ãŸã‚ã€æš—å·ã‚«ãƒ©ãƒ ã«ã¯ `AS \`table\_\_column\`\`
ã®å½¢å¼ã§åˆ¥åã‚’ä»˜ã‘ã‚‹ã¨ç¢ºå®Ÿã§ã™ã€‚

``` php
$sql = "
SELECT
  r.id,
  r.name          AS `restorations__name`,
  r.tel           AS `restorations__tel`,
  o.name          AS `orders__order_name`,
  o.ordered_at
FROM restorations AS r
LEFT JOIN orders AS o ON o.id = r.now_id
WHERE r.status = ?
";

$result = $db->query($sql, ['active']);
```

------------------------------------------------------------------------

### 4ï¸âƒ£ INSERT ... SELECTï¼ˆå¾©å·â†’å†æš—å·åŒ–ï¼‰

SELECTã§å–å¾—ã—ãŸæš—å·ã‚«ãƒ©ãƒ ã‚’å¾©å·ã—ã¦ã‹ã‚‰ã€\
INSERTå…ˆã®æš—å·ã‚«ãƒ©ãƒ ã¸å†æš—å·åŒ–ã—ã¦æŒ¿å…¥ã—ã¾ã™ã€‚

``` php
$sql = "
INSERT INTO orders_backup (
  backup_id, name, address, tel, branch, okuyami, backup_at
)
SELECT
  id AS backup_id,
  name,
  address,
  tel,
  branch,
  okuyami,
  ? AS backup_at
FROM orders
WHERE id = ?
";

$result = $db->query($sql, [$now, $order_id]);
```

> âš ï¸ SELECT å´ã®åˆ—åã¯ INSERT å´ã¨ä¸€è‡´ã•ã›ã¦ãã ã•ã„ã€‚\
> ä¸€è‡´ã—ãªã„å ´åˆã¯ `AS` ã§åˆ¥åã‚’æŒ‡å®šï¼ˆä¾‹ï¼š`id AS backup_id`ï¼‰ã€‚

------------------------------------------------------------------------

### 5ï¸âƒ£ é€šå¸¸ã®INSERT / UPDATE

``` php
$db->query(
  "INSERT INTO users (user_id, email, password) VALUES (?, ?, ?)",
  ['test', 'mail@example.com', 'secret']
);
```

æš—å·åŒ–å¯¾è±¡ã‚«ãƒ©ãƒ ã¯è‡ªå‹•çš„ã«æš—å·åŒ–ã•ã‚Œã¾ã™ã€‚

------------------------------------------------------------------------

### 6ï¸âƒ£ ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³æ“ä½œ

``` php
$db->beginTransaction();
$db->query("UPDATE users SET name=? WHERE id=?", ['Alice', 1]);
$db->commit();
// $db->rollback(); // å¤±æ•—æ™‚
```

------------------------------------------------------------------------

## ğŸ” æš—å·åŒ–ã®ä»•æ§˜

-   æš—å·åŒ–ã¯ **AES-256-CBC** ã‚’ä½¿ç”¨\
-   `openssl_encrypt()` / `openssl_decrypt()` ã«ã‚ˆã‚‹å®‰å…¨ãªå‡¦ç†\
-   IVï¼ˆåˆæœŸåŒ–ãƒ™ã‚¯ãƒˆãƒ«ï¼‰ã¯16ãƒã‚¤ãƒˆãƒ©ãƒ³ãƒ€ãƒ ç”Ÿæˆã—ã€æš—å·æ–‡ã®å…ˆé ­ã«çµåˆ\
-   ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ä¸Šã«ã¯ Base64 æ–‡å­—åˆ—ã§ä¿å­˜ã•ã‚Œã¾ã™\
-   æš—å·åŒ–ã‚­ãƒ¼ã¯ 16ï½32æ–‡å­—ã‚’æ¨å¥¨ï¼ˆAES-256å¯¾å¿œï¼‰

------------------------------------------------------------------------

## ğŸ§© JOINã¨å¾©å·ã®ä»•çµ„ã¿

-   å¾©å·ã¯ `getColumnMeta()`ï¼ˆPDOï¼‰ã¾ãŸã¯
    `fetch_fields()`ï¼ˆMySQLiï¼‰ã§åˆ—ãƒ¡ã‚¿æƒ…å ±ã‚’å–å¾—\
-   åˆ—ãƒ¡ã‚¿ã«åŸºã¥ãã€Œãƒ†ãƒ¼ãƒ–ãƒ«å Ã— ã‚«ãƒ©ãƒ åã€ã§è‡ªå‹•å¾©å·\
-   PDOãƒ‰ãƒ©ã‚¤ãƒãŒãƒ†ãƒ¼ãƒ–ãƒ«åã‚’è¿”ã•ãªã„å ´åˆã‚‚ã€`table__column`
    å½¢å¼ã®ã‚¨ã‚¤ãƒªã‚¢ã‚¹ã‚’è§£æã—ã¦å¾©å·å¯èƒ½

------------------------------------------------------------------------

## âš™ï¸ INSERT ... SELECT ã®å†…éƒ¨å‹•ä½œ

1.  `INSERT ... SELECT` ã‚’æ¤œå‡º\
2.  SELECTã‚’å®Ÿè¡Œ â†’ æš—å·ã‚«ãƒ©ãƒ ã‚’å¾©å·\
3.  çµæœã‚’å†æš—å·åŒ–ã—ã¦æŒ¿å…¥\
4.  å¤§é‡ãƒ‡ãƒ¼ã‚¿ã¯è‡ªå‹•ã§1000è¡Œã”ã¨ã«ãƒãƒ£ãƒ³ã‚¯å‡¦ç†\
5.  æ—¢å­˜ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ä¸­ãªã‚‰ãã®ã¾ã¾å‚åŠ ï¼ˆPDOã¯è‡ªå‹•ç®¡ç†ï¼‰

------------------------------------------------------------------------

## âš ï¸ æ³¨æ„äº‹é …

-   `UNION`ã€`ã‚µãƒ–ã‚¯ã‚¨ãƒªã‚’å¤šæ®µã«ãƒã‚¹ãƒˆ` ã—ãŸSQLã¯ã‚µãƒãƒ¼ãƒˆå¤–\
-   SELECTå´ã¨INSERTå´ã®åˆ—åãƒ»é †åºã¯å¿…ãšä¸€è‡´ã•ã›ã¦ãã ã•ã„\
-   æš—å·åŒ–å¯¾è±¡ã§ãªã„ã‚«ãƒ©ãƒ ã¯å¹³æ–‡ã®ã¾ã¾æ‰±ã‚ã‚Œã¾ã™\
-   æš—å·åŒ–ã‚­ãƒ¼ã¯**ã‚¢ãƒ—ãƒªå†…ã«å¹³æ–‡ã§ä¿æŒã—ãªã„**ã‚ˆã†æ³¨æ„\
-   æ–‡å­—ã‚³ãƒ¼ãƒ‰ã¯ `utf8mb4` ã‚’æ¨å¥¨

------------------------------------------------------------------------

## ğŸ§  å®Ÿè¡Œä¾‹ã¾ã¨ã‚

``` php
$db = new Database($config['db']);

// JOINä»˜ãSELECT
$users = $db->query("SELECT u.id, u.email, p.name AS `profiles__name` FROM users u LEFT JOIN profiles p ON p.user_id = u.id");

// INSERT ... SELECT
$db->query("
  INSERT INTO users_backup (backup_id, email, name, backup_at)
  SELECT id AS backup_id, email, name, ? AS backup_at FROM users WHERE id = ?
", [$now, $uid]);
```

------------------------------------------------------------------------

## ğŸ§¾ ãƒ©ã‚¤ã‚»ãƒ³ã‚¹

MIT License\
è‡ªç”±ã«æ”¹å¤‰ãƒ»å†é…å¸ƒå¯èƒ½ã§ã™ã€‚å•†ç”¨åˆ©ç”¨å¯ã€‚

------------------------------------------------------------------------

## ğŸ§‘â€ğŸ’» ä½œè€…

**AI Mandala Laboratory**\
é–‹ç™ºãƒ»ç›£ä¿®ï¼šã¾ãŠã¡

------------------------------------------------------------------------

[![PHP Version](https://img.shields.io/badge/PHP-%3E%3D8.0-blue)]()
[![License](https://img.shields.io/badge/license-MIT-green)]()

------------------------------------------------------------------------

### ğŸ” æ¨å¥¨é‹ç”¨ãƒ«ãƒ¼ãƒ«

  é …ç›®                æ¨å¥¨è¨­å®š
  ------------------- --------------------------------------------------
  PDOåˆ©ç”¨             `ATTR_EMULATE_PREPARES = false`
  æ–‡å­—ã‚³ãƒ¼ãƒ‰          `utf8mb4`
  æš—å·åŒ–ã‚­ãƒ¼          16ï½32æ–‡å­—
  æš—å·å¯¾è±¡åˆ—å        ã§ãã‚‹é™ã‚Šæ˜ç¤ºçš„ã« `AS table__column` å½¢å¼ã‚’ä»˜ä¸
  INSERT ... SELECT   æŒ¿å…¥å…ˆã¨åŒåã‚«ãƒ©ãƒ ã«åˆã‚ã›ã¦ASæŒ‡å®š
